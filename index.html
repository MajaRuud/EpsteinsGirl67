<!doctype html>
<html lang="nn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nynorsk verbspel</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --muted:#a8b0c2;
      --text:#eef1f7;
      --line:#232635;
      --good:#20c997;
      --bad:#ff5b5b;
      --warn:#ffd166;
      --btn:#1b1f2b;
      --btnHover:#23283a;
      --focus:#7aa2ff;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb;
        --card:#ffffff;
        --muted:#5b6478;
        --text:#0f1220;
        --line:#e6e9f2;
        --btn:#f3f5fb;
        --btnHover:#e9edf8;
        --shadow: 0 10px 24px rgba(15,18,32,.08);
        --focus:#2b6cff;
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(900px 500px at 20% 10%, rgba(122,162,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(32,201,151,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      line-height: 1.4;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 16px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      font-size: clamp(20px, 3vw, 28px);
      margin:0;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      max-width: 60ch;
    }

    .card{
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding: 14px 14px 12px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }
    .stats{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--btn) 88%, transparent);
      color: var(--text);
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .pill b{ font-weight:700; }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button, select, input[type="checkbox"]{
      font: inherit;
    }
    .btn{
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ background: var(--btnHover); }
    .btn:focus-visible, select:focus-visible, .option:focus-visible, .textAnswer input:focus-visible{
      outline: 3px solid color-mix(in srgb, var(--focus) 55%, transparent);
      outline-offset: 2px;
    }
    .btn.primary{
      border-color: color-mix(in srgb, var(--focus) 55%, var(--line));
      background: color-mix(in srgb, var(--focus) 18%, var(--btn));
    }
    .btn.danger{
      border-color: color-mix(in srgb, var(--bad) 60%, var(--line));
      background: color-mix(in srgb, var(--bad) 10%, var(--btn));
    }

    main{
      padding: 16px;
      display:grid;
      gap:16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
      .controls{ justify-content:flex-start; }
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      background: color-mix(in srgb, var(--card) 84%, transparent);
    }
    .panel h2{
      margin:0 0 8px;
      font-size: 16px;
    }
    .panel p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
    }

    .questionBox{
      padding: 16px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg,
        color-mix(in srgb, var(--card) 92%, transparent),
        color-mix(in srgb, var(--card) 80%, transparent)
      );
      display:grid;
      gap: 10px;
    }
    .qHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .qType{
      color: var(--muted);
      font-size: 13px;
    }
    .qPrompt{
      font-size: clamp(18px, 2.5vw, 22px);
      margin:0;
    }
    .qPrompt .verb{
      font-weight:800;
      letter-spacing:.2px;
    }
    .hint{
      display:none;
      margin-top: 6px;
      font-size: 13px;
      color: color-mix(in srgb, var(--warn) 80%, var(--text));
      border-left: 3px solid color-mix(in srgb, var(--warn) 80%, transparent);
      padding: 8px 10px;
      background: color-mix(in srgb, var(--warn) 10%, transparent);
      border-radius: 12px;
    }
    .hint.show{ display:block; }

    .options{
      display:grid;
      gap:10px;
      margin-top: 4px;
    }
    .option{
      text-align:left;
      width:100%;
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s ease;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .option:hover{ background: var(--btnHover); }
    .option small{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .feedback{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 12px;
      background: color-mix(in srgb, var(--card) 85%, transparent);
    }
    .msg{
      font-size: 14px;
      color: var(--muted);
    }
    .msg b{ color: var(--text); }
    .msg.good b{ color: var(--good); }
    .msg.bad  b{ color: var(--bad); }

    .settingsRow{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    label{
      font-size: 13px;
      color: var(--muted);
    }
    select{
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      min-width: 220px;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .toggle input{
      width: 18px;
      height: 18px;
      accent-color: var(--focus);
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--line);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      text-align:left;
    }
    .table th{
      background: color-mix(in srgb, var(--btn) 65%, transparent);
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      letter-spacing:.2px;
    }
    .table tr:last-child td{ border-bottom:none; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 2px 6px;
      border:1px solid var(--line);
      border-radius: 8px;
      background: color-mix(in srgb, var(--btn) 60%, transparent);
      font-size: 12px;
      color: var(--text);
    }
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Nynorsk verbspel</h1>
        <p class="subtitle">
          Eit lite spel for √• √∏ve p√• b√∏ying av vanlege nynorskverb.
          Vel niv√• og tid, svar, og bygg streak. Passar fint p√• smarttavle og elev-PC.
        </p>
      </div>
    </header>

    <section class="card" aria-label="Spel">
      <div class="topbar">
        <div class="stats" aria-live="polite">
          <span class="pill" title="Poeng">
            üèÅ Poeng: <b id="score">0</b>
          </span>
          <span class="pill" title="Rett p√• rad">
            üî• Streak: <b id="streak">0</b>
          </span>
          <span class="pill" title="Rett svar / totalt">
            ‚úÖ Treff: <b id="accuracy">0/0</b>
          </span>
          <span class="pill" title="Tid att">
            ‚è±Ô∏è Tid: <b id="timer">‚Äî</b>
          </span>
        </div>

        <div class="controls">
          <button class="btn" id="hintBtn" type="button" title="Vis eit hint">
            üí° Hint
          </button>
          <button class="btn primary" id="nextBtn" type="button" title="Hopp til neste oppg√•ve">
            ‚Üª Ny oppg√•ve
          </button>
          <button class="btn danger" id="resetBtn" type="button" title="Nullstill poeng og start p√• nytt">
            ‚ü≤ Start p√• nytt
          </button>
        </div>
      </div>

      <main>
        <div class="grid">
          <div class="questionBox" aria-label="Oppg√•ve">
            <div class="qHeader">
              <div class="qType" id="qType">Oppg√•vetype</div>
              <div class="qType">Tastatur: <span class="kbd">1</span>‚Äì<span class="kbd">4</span></div>
            </div>

            <p class="qPrompt" id="qPrompt">
              B√∏y <span class="verb">kome</span> i <b>preteritum</b>.
            </p>

            <div class="hint" id="hintBox" role="note" aria-live="polite"></div>

            <div class="options" id="options" role="group" aria-label="Svaralternativ">
              <!-- knappar blir sette inn her -->
            </div>

            <div class="feedback" aria-label="Tilbakemelding">
              <div class="msg" id="msg">Vel eit svar for √• starte.</div>
              <div>
                <button class="btn" id="showAnswerBtn" type="button" title="Vis fasit og b√∏yinga (l√¶ringsmodus)">
                  üìå Vis b√∏ying
                </button>
              </div>
            </div>
          </div>

          <aside class="panel" aria-label="Innstillingar og oversikt">
            <h2>Innstillingar</h2>
            <p>Tilpass spelet til niv√• og √∏ving.</p>

            <div class="settingsRow" role="group" aria-label="Innstillingar">
              <div class="row">
                <label for="level">Niv√• (verbtypar):</label>
                <select id="level">
                  <option value="basic">Niv√• 1: Vanlege sterke og svake</option>
                  <option value="medium" selected>Niv√• 2: Fleire sterke + vanskelege</option>
                  <option value="all">Niv√• 3: Alle i lista</option>
                </select>
              </div>

              <div class="row">
                <label for="mode">Spelmodus:</label>
                <select id="mode">
                  <option value="mc" selected>Fleirval (4 alternativ)</option>
                  <option value="mixed">Blanda (fleirval + skriv)</option>
                </select>
              </div>

              <div class="row">
                <label for="duration">Runde (tid):</label>
                <select id="duration">
                  <option value="0">Utan tid</option>
                  <option value="60">60 sekund</option>
                  <option value="120" selected>2 minutt</option>
                  <option value="180">3 minutt</option>
                </select>
              </div>

              <div class="row">
                <span class="toggle">
                  <input type="checkbox" id="learnMode" />
                  <label for="learnMode">L√¶ringsmodus (viser fasit etter svar)</label>
                </span>
              </div>
            </div>

            <div class="mini">
              Tips: Bruk <span class="kbd">1</span>‚Äì<span class="kbd">4</span> for √• svare raskt.
              Trykk <span class="kbd">Enter</span> i skrivemodus.
            </div>

            <table class="table" aria-label="B√∏ying (fasit)">
              <thead>
                <tr>
                  <th>Infinitiv</th>
                  <th>Presens</th>
                  <th>Preteritum</th>
                  <th>Perfektum partisipp</th>
                </tr>
              </thead>
              <tbody id="conjTable">
                <tr>
                  <td colspan="4" style="color:var(--muted)">Trykk ¬´Vis b√∏ying¬ª for √• sj√• fasit her.</td>
                </tr>
              </tbody>
            </table>
          </aside>
        </div>
      </main>
    </section>
  </div>

  <script>
    "use strict";

    // -----------------------------
    // Data: sm√•, robuste verb-sett
    // -----------------------------
    // Merk: Dette er ei praktisk √∏vingsliste (ikkje ei komplett ordliste).
    // Felt: inf, pres, pret, perf, type (weak/strong), level (basic/medium/all)
    const VERBS = [
      // Niv√• 1 (vanlege)
      { inf:"√• vere",  pres:"er",       pret:"var",      perf:"vore",     type:"strong", level:"basic" },
      { inf:"√• ha",    pres:"har",      pret:"hadde",    perf:"hatt",     type:"weak",   level:"basic" },
      { inf:"√• gjere", pres:"gjer",     pret:"gjorde",   perf:"gjort",    type:"weak",   level:"basic" },
      { inf:"√• kome",  pres:"kjem",     pret:"kom",      perf:"kome",     type:"strong", level:"basic" },
      { inf:"√• g√•",    pres:"g√•r",      pret:"gjekk",    perf:"g√•tt",     type:"strong", level:"basic" },
      { inf:"√• sj√•",   pres:"ser",      pret:"s√•g",      perf:"sett",     type:"strong", level:"basic" },
      { inf:"√• seie",  pres:"seier",    pret:"sa",       perf:"sagt",     type:"strong", level:"strong", level:"basic" }, // strong-ish
      { inf:"√• f√•",    pres:"f√•r",      pret:"fekk",     perf:"f√•tt",     type:"strong", level:"basic" },
      { inf:"√• ta",    pres:"tek",      pret:"tok",      perf:"teke",     type:"strong", level:"basic" },
      { inf:"√• skrive",pres:"skriv",    pret:"skreiv",   perf:"skrive",   type:"strong", level:"basic" },
      { inf:"√• lese",  pres:"les",      pret:"las",      perf:"lese",     type:"strong", level:"basic" },
      { inf:"√• bu",    pres:"bur",      pret:"budde",    perf:"budd",     type:"weak",   level:"basic" },
      { inf:"√• kj√∏pe", pres:"kj√∏per",   pret:"kj√∏pte",   perf:"kj√∏pt",    type:"weak",   level:"basic" },
      { inf:"√• snakke",pres:"snakkar",  pret:"snakka",   perf:"snakka",   type:"weak",   level:"basic" },
      { inf:"√• leve",  pres:"lever",    pret:"levde",    perf:"levd",     type:"weak",   level:"basic" },

      // Niv√• 2 (fleire / litt vanskeleg)
      { inf:"√• finne", pres:"finn",     pret:"fann",     perf:"funne",    type:"strong", level:"medium" },
      { inf:"√• bli",   pres:"blir",     pret:"vart",     perf:"vorte",    type:"strong", level:"medium" },
      { inf:"√• liggje",pres:"ligg",     pret:"l√•g",      perf:"lege",     type:"strong", level:"medium" },
      { inf:"√• sitje", pres:"sit",      pret:"sat",      perf:"site",     type:"strong", level:"medium" },
      { inf:"√• drikke",pres:"drikk",    pret:"drakk",    perf:"drukke",   type:"strong", level:"medium" },
      { inf:"√• ete",   pres:"et",       pret:"√•t",       perf:"ete",      type:"strong", level:"medium" },
      { inf:"√• gje",   pres:"gjev",     pret:"gav",      perf:"gjeve",    type:"strong", level:"medium" },
      { inf:"√• st√•",   pres:"st√•r",     pret:"stod",     perf:"st√•tt",    type:"strong", level:"medium" },
      { inf:"√• halde", pres:"held",     pret:"heldt",    perf:"halde",    type:"strong", level:"medium" },
      { inf:"√• hjelpe",pres:"hjelper",  pret:"hjelpte",  perf:"hjelpt",   type:"weak",   level:"medium" },
      { inf:"√• tru",   pres:"trur",     pret:"trudde",   perf:"trudd",    type:"weak",   level:"medium" },
      { inf:"√• kjenne",pres:"kjenner",  pret:"kjende",   perf:"kjent",    type:"weak",   level:"medium" },

      // Niv√• 3 / "all" (ekstra)
      { inf:"√• breste",pres:"brest",    pret:"brast",    perf:"broste",   type:"strong", level:"all" },
      { inf:"√• springe",pres:"spring",  pret:"sprang",   perf:"sprunge",  type:"strong", level:"all" },
      { inf:"√• fryse", pres:"frys",     pret:"fraus",    perf:"frose",    type:"strong", level:"all" },
      { inf:"√• skode", pres:"skodar",   pret:"skoda",    perf:"skoda",    type:"weak",   level:"all" },
    ].map(v => {
      // Liten normalisering: nokre objekt hadde dobbelt level (pga kommentar). Rydd opp:
      const copy = {...v};
      if (Array.isArray(copy.level)) copy.level = copy.level[0];
      return copy;
    });

    const FORMS = [
      { key:"pres", label:"presens", hint:"Kva skjer no? (i dag, no, vanlegvis)" },
      { key:"pret", label:"preteritum", hint:"Kva skjedde f√∏r? (i g√•r, i fjor, for lenge sidan)" },
      { key:"perf", label:"perfektum partisipp", hint:"Brukt med ¬´har¬ª: har ‚Ä¶ (gjeve, funne, kj√∏pt)" },
    ];

    // -----------------------------
    // State
    // -----------------------------
    const state = {
      score: 0,
      streak: 0,
      correct: 0,
      total: 0,
      roundSeconds: 120,
      timeLeft: null,
      timerId: null,
      current: null, // {verb, formKey}
      locked: false,
      lastShownConjInf: null
    };

    // -----------------------------
    // DOM
    // -----------------------------
    const el = {
      score: document.getElementById("score"),
      streak: document.getElementById("streak"),
      accuracy: document.getElementById("accuracy"),
      timer: document.getElementById("timer"),
      qType: document.getElementById("qType"),
      qPrompt: document.getElementById("qPrompt"),
      options: document.getElementById("options"),
      msg: document.getElementById("msg"),
      hintBox: document.getElementById("hintBox"),
      hintBtn: document.getElementById("hintBtn"),
      nextBtn: document.getElementById("nextBtn"),
      resetBtn: document.getElementById("resetBtn"),
      showAnswerBtn: document.getElementById("showAnswerBtn"),
      conjTable: document.getElementById("conjTable"),
      level: document.getElementById("level"),
      mode: document.getElementById("mode"),
      duration: document.getElementById("duration"),
      learnMode: document.getElementById("learnMode"),
    };

    // -----------------------------
    // Helpers
    // -----------------------------
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function randInt(max){ return Math.floor(Math.random() * max); }
    function pick(arr){ return arr[randInt(arr.length)]; }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function normalizeAnswer(s){
      return (s || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
    }

    function verbsForLevel(levelValue){
      if(levelValue === "basic") return VERBS.filter(v => v.level === "basic");
      if(levelValue === "medium"){
        return VERBS.filter(v => v.level === "basic" || v.level === "medium");
      }
      return VERBS.slice(); // all
    }

    function formatTime(seconds){
      if(seconds == null) return "‚Äî";
      const m = Math.floor(seconds/60);
      const s = seconds%60;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function setMessage(kind, html){
      el.msg.classList.remove("good","bad");
      if(kind) el.msg.classList.add(kind);
      el.msg.innerHTML = html;
    }

    function updateStats(){
      el.score.textContent = String(state.score);
      el.streak.textContent = String(state.streak);
      el.accuracy.textContent = `${state.correct}/${state.total}`;
      el.timer.textContent = (state.roundSeconds === 0) ? "‚Äî" : formatTime(state.timeLeft);
    }

    function startTimerIfNeeded(){
      stopTimer();
      const secs = Number(el.duration.value || 0);
      state.roundSeconds = secs;
      if(secs === 0){
        state.timeLeft = null;
        updateStats();
        return;
      }
      state.timeLeft = secs;
      updateStats();
      state.timerId = window.setInterval(() => {
        state.timeLeft = clamp(state.timeLeft - 1, 0, 10**9);
        updateStats();
        if(state.timeLeft === 0){
          stopTimer();
          state.locked = true;
          setMessage("bad", `<b>Tida er ute.</b> Trykk ¬´Ny oppg√•ve¬ª for √• halde fram.`);
          // Disable options
          disableOptions(true);
        }
      }, 1000);
    }

    function stopTimer(){
      if(state.timerId){
        clearInterval(state.timerId);
        state.timerId = null;
      }
    }

    function disableOptions(disabled){
      const btns = el.options.querySelectorAll("button.option");
      btns.forEach(b => b.disabled = disabled);
    }

    function renderConjTable(verb){
      el.conjTable.innerHTML = `
        <tr>
          <td><b>${escapeHtml(verb.inf)}</b></td>
          <td>${escapeHtml(verb.pres)}</td>
          <td>${escapeHtml(verb.pret)}</td>
          <td>${escapeHtml(verb.perf)}</td>
        </tr>
      `;
      state.lastShownConjInf = verb.inf;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // -----------------------------
    // Question generation
    // -----------------------------
    function newQuestion(){
      state.locked = false;
      el.hintBox.classList.remove("show");
      el.hintBox.textContent = "";

      const pool = verbsForLevel(el.level.value);
      const verb = pick(pool);
      const form = pick(FORMS);

      state.current = { verb, formKey: form.key, formLabel: form.label, formHint: form.hint };

      const mode = el.mode.value;
      const useTyping = (mode === "mixed") ? (Math.random() < 0.35) : false;

      el.qType.textContent = useTyping ? "Skriv svar" : "Fleirval";

      el.qPrompt.innerHTML = `B√∏y <span class="verb">${escapeHtml(verb.inf.replace(/^√•\s+/,""))}</span> i <b>${escapeHtml(form.label)}</b>.`;

      el.options.innerHTML = "";
      if(useTyping){
        renderTypingInput();
      }else{
        renderMultipleChoice(pool, verb, form.key);
      }

      setMessage(null, `Vel eit svar for √• starte.`);
      updateStats();
      focusFirstOption();
    }

    function renderTypingInput(){
      const wrap = document.createElement("div");
      wrap.className = "textAnswer";
      wrap.style.display = "grid";
      wrap.style.gap = "10px";

      const input = document.createElement("input");
      input.type = "text";
      input.autocomplete = "off";
      input.spellcheck = false;
      input.placeholder = "Skriv svaret her og trykk Enter‚Ä¶";
      input.style.border = "1px solid var(--line)";
      input.style.background = "var(--btn)";
      input.style.color = "var(--text)";
      input.style.padding = "12px 12px";
      input.style.borderRadius = "14px";

      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.type = "button";
      btn.textContent = "Svar";

      const correct = state.current.verb[state.current.formKey];

      function submit(){
        if(state.locked) return;
        const val = normalizeAnswer(input.value);
        const ok = val === normalizeAnswer(correct);
        handleResult(ok, correct, "typing");
      }

      input.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          submit();
        }
      });
      btn.addEventListener("click", submit);

      wrap.appendChild(input);
      wrap.appendChild(btn);
      el.options.appendChild(wrap);

      window.setTimeout(() => input.focus(), 0);
    }

    function renderMultipleChoice(pool, verb, formKey){
      const correct = verb[formKey];

      // Distraktorar: same formKey fr√• andre verb, unike og ulike fr√• fasit
      const distractors = [];
      const seen = new Set([normalizeAnswer(correct)]);
      const shuffledPool = shuffle(pool);

      for(const v of shuffledPool){
        if(distractors.length >= 3) break;
        const cand = v[formKey];
        const n = normalizeAnswer(cand);
        if(!seen.has(n)){
          seen.add(n);
          distractors.push(cand);
        }
      }

      // Fallback: dersom for f√•, ta fr√• heile lista
      if(distractors.length < 3){
        for(const v of shuffle(VERBS)){
          if(distractors.length >= 3) break;
          const cand = v[formKey];
          const n = normalizeAnswer(cand);
          if(!seen.has(n)){
            seen.add(n);
            distractors.push(cand);
          }
        }
      }

      const options = shuffle([correct, ...distractors]).slice(0,4);

      options.forEach((text, idx) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "option";
        b.setAttribute("data-idx", String(idx));
        b.innerHTML = `<span>${escapeHtml(text)}</span><small>${idx+1}</small>`;

        b.addEventListener("click", () => {
          if(state.locked) return;
          const ok = normalizeAnswer(text) === normalizeAnswer(correct);
          handleResult(ok, correct, "mc", b);
        });

        el.options.appendChild(b);
      });
    }

    function focusFirstOption(){
      const first = el.options.querySelector("button.option");
      if(first) first.focus();
    }

    // -----------------------------
    // Result handling
    // -----------------------------
    function handleResult(ok, correctAnswer, kind, clickedBtn){
      state.locked = true;
      state.total += 1;

      if(ok){
        state.correct += 1;
        state.streak += 1;
        // Poeng: base 10 + streakbonus
        const gained = 10 + Math.min(state.streak, 10);
        state.score += gained;

        setMessage("good", `<b>Rett!</b> +${gained} poeng. (${escapeHtml(correctAnswer)})`);
      }else{
        state.streak = 0;
        setMessage("bad", `<b>Feil.</b> Riktig svar er: <b>${escapeHtml(correctAnswer)}</b>.`);
      }

      // L√¶ringsmodus: alltid vis b√∏ying
      if(el.learnMode.checked){
        renderConjTable(state.current.verb);
      }

      // Disable choices (MC)
      if(kind === "mc"){
        disableOptions(true);
        // Vis lite "markering" ved √• endre tekst (uten fargar/ikon-bibliotek)
        if(clickedBtn){
          clickedBtn.innerHTML = clickedBtn.innerHTML + (ok ? ` <small>(rett)</small>` : ` <small>(valde)</small>`);
        }
      }

      updateStats();
      // Auto-g√• vidare etter kort pause (men berre om det er tid att / utan tid)
      const canContinue = (state.roundSeconds === 0) || (state.timeLeft && state.timeLeft > 0);
      if(canContinue){
        window.setTimeout(() => newQuestion(), 900);
      }
    }

    // -----------------------------
    // Actions
    // -----------------------------
    function showHint(){
      if(!state.current) return;
      el.hintBox.textContent = state.current.formHint;
      el.hintBox.classList.add("show");
    }

    function showAnswer(){
      if(!state.current) return;
      renderConjTable(state.current.verb);
      setMessage(null, `B√∏ying vist for <b>${escapeHtml(state.current.verb.inf)}</b>.`);
    }

    function resetGame(){
      state.score = 0;
      state.streak = 0;
      state.correct = 0;
      state.total = 0;
      state.locked = false;
      el.conjTable.innerHTML = `
        <tr>
          <td colspan="4" style="color:var(--muted)">Trykk ¬´Vis b√∏ying¬ª for √• sj√• fasit her.</td>
        </tr>
      `;
      startTimerIfNeeded();
      newQuestion();
    }

    // -----------------------------
    // Keyboard shortcuts
    // -----------------------------
    document.addEventListener("keydown", (e) => {
      // 1-4 for MC
      if(state.locked) return;
      const k = e.key;
      if(k >= "1" && k <= "4"){
        const idx = Number(k) - 1;
        const btn = el.options.querySelector(`button.option[data-idx="${idx}"]`);
        if(btn && !btn.disabled){
          btn.click();
        }
      }
      // H for hint
      if(k.toLowerCase() === "h"){
        showHint();
      }
    });

    // -----------------------------
    // Wire up UI
    // -----------------------------
    el.hintBtn.addEventListener("click", showHint);
    el.nextBtn.addEventListener("click", () => {
      if(state.roundSeconds !== 0 && state.timeLeft === 0){
        // dersom runden var over: restart timer p√• ny oppg√•ve
        startTimerIfNeeded();
      }
      newQuestion();
    });
    el.resetBtn.addEventListener("click", resetGame);
    el.showAnswerBtn.addEventListener("click", showAnswer);

    el.level.addEventListener("change", () => newQuestion());
    el.mode.addEventListener("change", () => newQuestion());
    el.duration.addEventListener("change", () => {
      startTimerIfNeeded();
      // ny oppg√•ve for √• gi "ny runde"-f√∏lelse
      newQuestion();
    });

    // -----------------------------
    // Init
    // -----------------------------
    startTimerIfNeeded();
    newQuestion();
  </script>
</body>
</html>
